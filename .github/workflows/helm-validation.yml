name: Helm Validation (Pull Request)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "helm-recype/**"

env:
  HELM_CHART_PATH: ./helm-recype

jobs:
  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Helm lint
        run: |
          echo "Running Helm lint..."
          helm lint ${{ env.HELM_CHART_PATH }} --strict

      - name: Helm template validation
        run: |
          echo "Validating Helm templates..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --debug > /tmp/manifest.yaml
          echo "Generated manifest contains $(wc -l < /tmp/manifest.yaml) lines"

      - name: Validate against Kubernetes schema
        run: |
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          helm template ms-payments ${{ env.HELM_CHART_PATH }} | ./kubeval --strict

      - name: Check for deprecated APIs
        run: |
          echo "Checking for deprecated Kubernetes APIs..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} | grep -i "deprecated" && echo "Warning: Deprecated APIs found" || echo "No deprecated APIs found"

      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Helm chart validation completed successfully!'
            })
