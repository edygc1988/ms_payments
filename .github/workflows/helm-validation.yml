name: Helm Validation (Pull Request)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "helm-recype/**"

env:
  HELM_CHART_PATH: ./helm-recype

jobs:
  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Helm lint
        run: |
          echo "Running Helm lint..."
          helm lint ${{ env.HELM_CHART_PATH }} --strict

      - name: Helm template validation
        run: |
          echo "Validating Helm templates..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --debug > /tmp/manifest.yaml
          echo "Generated manifest contains $(wc -l < /tmp/manifest.yaml) lines"

      - name: Validate manifests YAML syntax
        run: |
          echo "Validating YAML syntax..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} > /tmp/manifest.yaml
          # Ensure PyYAML is available
          python3 -m pip install --user pyyaml >/dev/null
          python3 - <<'PY'
          import sys, yaml
          path = '/tmp/manifest.yaml'
          try:
            docs = list(yaml.safe_load_all(open(path)))
          except Exception as e:
            print('ERROR: YAML parse error in generated manifest:', file=sys.stderr)
            print(e, file=sys.stderr)
            print('\n--- manifest excerpt ---', file=sys.stderr)
            with open(path) as f:
              for i, line in enumerate(f):
                if i < 200:
                  sys.stderr.write(line)
                else:
                  break
            sys.exit(1)
          if not docs:
            print('ERROR: No YAML documents generated', file=sys.stderr)
            sys.exit(1)
          print(f"✓ YAML parsed OK: {len(docs)} documents")
          PY

      - name: Check for common issues
        run: |
          echo "Checking for common Helm issues..."
          MANIFEST=$(helm template ms-payments ${{ env.HELM_CHART_PATH }})

          # Check for required fields
          echo "$MANIFEST" | grep -q "kind:" && echo "✓ Kind field present" || (echo "Error: No kind field found" && exit 1)
          echo "$MANIFEST" | grep -q "metadata:" && echo "✓ Metadata present" || (echo "Error: No metadata found" && exit 1)
          echo "$MANIFEST" | grep -q "name:" && echo "✓ Name field present" || echo "⚠ No name field (might be OK)"

          # Check for deprecated APIs
          if echo "$MANIFEST" | grep -q "apiVersion: extensions/v1beta1"; then
            echo "Error: Found deprecated extensions/v1beta1 API version"
            exit 1
          else
            echo "✓ No deprecated extensions/v1beta1 APIs"
          fi

          # Check image configuration
          if echo "$MANIFEST" | grep -q "image:"; then
            echo "✓ Container image configured"
          else
            echo "⚠ No container image found"
          fi

      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Helm chart validation completed successfully!'
            })
