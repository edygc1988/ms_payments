name: Helm Validation (Pull Request)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "helm-recype/**"

env:
  HELM_CHART_PATH: ./helm-recype

jobs:
  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Helm lint
        run: |
          echo "Running Helm lint..."
          helm lint ${{ env.HELM_CHART_PATH }} --strict

      - name: Helm template validation
        run: |
          echo "Validating Helm templates..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --debug > /tmp/manifest.yaml
          echo "Generated manifest contains $(wc -l < /tmp/manifest.yaml) lines"

      - name: Validate manifests YAML syntax
        run: |
          echo "Validating YAML syntax..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} > /tmp/manifest.yaml
          python3 -c "import yaml; yaml.safe_load(open('/tmp/manifest.yaml'))" && echo "✓ YAML syntax is valid" || exit 1

      - name: Check for common issues
        run: |
          echo "Checking for common Helm issues..."
          MANIFEST=$(helm template ms-payments ${{ env.HELM_CHART_PATH }})
          
          # Check for required fields
          echo "$MANIFEST" | grep -q "kind:" && echo "✓ Kind field present" || (echo "Error: No kind field found" && exit 1)
          echo "$MANIFEST" | grep -q "metadata:" && echo "✓ Metadata present" || (echo "Error: No metadata found" && exit 1)
          echo "$MANIFEST" | grep -q "name:" && echo "✓ Name field present" || echo "⚠ No name field (might be OK)"
          
          # Check for deprecated APIs
          if echo "$MANIFEST" | grep -q "apiVersion: extensions/v1beta1"; then
            echo "Error: Found deprecated extensions/v1beta1 API version"
            exit 1
          else
            echo "✓ No deprecated extensions/v1beta1 APIs"
          fi
          
          # Check image configuration
          if echo "$MANIFEST" | grep -q "image:"; then
            echo "✓ Container image configured"
          else
            echo "⚠ No container image found"
          fi      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Helm chart validation completed successfully!'
            })
