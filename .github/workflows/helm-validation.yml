name: Helm Validation (Pull Request)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "helm-recype/**"

env:
  HELM_CHART_PATH: ./helm-recype

jobs:
  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Helm lint
        run: |
          echo "Running Helm lint..."
          helm lint ${{ env.HELM_CHART_PATH }} --strict

      - name: Helm template validation
        run: |
          echo "Validating Helm templates..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --debug > /tmp/manifest.yaml
          echo "Generated manifest contains $(wc -l < /tmp/manifest.yaml) lines"

      - name: Validate manifests with kubectl dry-run
        run: |
          echo "Validating generated manifests..."
          helm template ms-payments ${{ env.HELM_CHART_PATH }} | \
            kubectl apply --dry-run=client -f - 2>&1 | \
            grep -i "error" && exit 1 || echo "✓ All manifests are valid"

      - name: Check for common issues
        run: |
          echo "Checking for common Helm issues..."
          MANIFEST=$(helm template ms-payments ${{ env.HELM_CHART_PATH }})

          # Check for required fields
          echo "$MANIFEST" | grep -q "kind:" && echo "✓ Kind field present" || echo "⚠ No kind field found"
          echo "$MANIFEST" | grep -q "metadata:" && echo "✓ Metadata present" || echo "⚠ No metadata found"

          # Check for deprecated APIs (v1beta1 extensions, etc)
          if echo "$MANIFEST" | grep -q "apiVersion: extensions/v1beta1"; then
            echo "⚠ Warning: Found deprecated extensions/v1beta1 API version"
          else
            echo "✓ No deprecated extensions/v1beta1 APIs"
          fi

          # Check image configuration
          if echo "$MANIFEST" | grep -q "image:"; then
            echo "✓ Container image configured"
          else
            echo "⚠ No container image found"
          fi

      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Helm chart validation completed successfully!'
            })
